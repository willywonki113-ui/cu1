<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebXR AR 큐브 배치 앱</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Three.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* 기본 스타일 설정 */
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: #000;
        }

        /* 캔버스가 전체 화면을 차지하도록 설정 */
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* WebXR 모드가 시작되기 전에 UI 오버레이를 위한 스타일 */
        #ar-ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none; /* 기본적으로 터치 이벤트를 캔버스로 전달 */
            z-index: 10;
        }

        /* AR 시작 버튼을 위한 스타일 (사용자 상호작용이 가능해야 함) */
        #ar-button-container {
            pointer-events: auto; /* 버튼만 터치 이벤트를 받도록 설정 */
        }
    </style>
    <script>
        // Three.js 및 WebXR 관련 전역 변수
        let container;
        let scene, camera, renderer;
        let xrSession = null;
        let xrRefSpace = null;
        let hitTestSource = null;
        let reticle = null; // 큐브를 배치할 위치를 나타내는 지시자
        const cubeGeometry = new THREE.BoxGeometry(0.1, 0.1, 0.1); // 10cm 큐브
        const cubeMaterial = new THREE.MeshPhongMaterial({ color: 0x4CAF50 }); // 녹색 큐브

        // 상수
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // ------------------------------------
        // WebXR 및 Three.js 초기화
        // ------------------------------------

        // 앱 초기화
        function init() {
            container = document.body;

            // 1. Three.js Scene, Camera, Renderer 설정
            scene = new THREE.Scene();

            // WebXR에서 카메라는 프레임마다 업데이트되므로 초기에는 더미 카메라를 사용합니다.
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.outputEncoding = THREE.sRGBEncoding;
            renderer.xr.enabled = true; // XR 모드 활성화
            container.appendChild(renderer.domElement);

            // 2. 리사이즈 핸들러
            window.addEventListener('resize', onWindowResize);

            // 3. AR 시작 버튼 기능 연결
            const arButton = document.getElementById('ar-start-button');
            if (arButton) {
                arButton.addEventListener('click', onStartAR);
            }

            // 4. 리트클(Reticle) 생성 (큐브 배치 위치를 표시)
            const reticleGeometry = new THREE.RingGeometry(0.05, 0.07, 32).rotateX(-Math.PI / 2);
            const reticleMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff });
            reticle = new THREE.Mesh(reticleGeometry, reticleMaterial);
            reticle.matrixAutoUpdate = false;
            reticle.visible = false;
            scene.add(reticle);

            // 5. 조명 추가 (큐브가 보이도록)
            scene.add(new THREE.HemisphereLight(0x808080, 0x606060, 1)); // 주변광

            // 6. AR 지원 여부 확인
            checkARSupport();
        }

        // AR 지원 확인 및 버튼 상태 업데이트
        function checkARSupport() {
            if (navigator.xr) {
                navigator.xr.isSessionSupported('immersive-ar')
                    .then((supported) => {
                        const arButton = document.getElementById('ar-start-button');
                        if (supported) {
                            arButton.textContent = 'AR 시작';
                            arButton.disabled = false;
                        } else {
                            arButton.textContent = 'AR 지원 불가';
                            arButton.disabled = true;
                            arButton.classList.add('bg-gray-400');
                        }
                    })
                    .catch((error) => {
                        console.error('AR 지원 확인 중 오류 발생:', error);
                        document.getElementById('ar-start-button').textContent = '오류 발생';
                        document.getElementById('ar-start-button').disabled = true;
                    });
            } else {
                document.getElementById('ar-start-button').textContent = 'WebXR을 지원하지 않는 브라우저';
                document.getElementById('ar-start-button').disabled = true;
                document.getElementById('ar-start-button').classList.add('bg-gray-400');
            }
        }

        // ------------------------------------
        // AR 세션 관리
        // ------------------------------------

        // 1. AR 모드 시작
        async function onStartAR() {
            const arButton = document.getElementById('ar-start-button');
            arButton.disabled = true;
            arButton.textContent = 'AR 시작 중...';
            
            try {
                // 필수 기능: hit-test (평면 감지), dom-overlay (UI 배치)
                const session = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['hit-test', 'dom-overlay'],
                    optionalFeatures: ['plane-detection'],
                    domOverlay: { root: document.body }
                });

                xrSession = session;
                renderer.xr.setSession(session);

                // UI 숨기기
                document.getElementById('ar-ui-overlay').style.display = 'none';

                // 세션 이벤트 리스너 설정
                session.addEventListener('end', onXRSessionEnded);
                session.addEventListener('select', onSelect); // 큐브 배치를 위한 탭 이벤트

                // 레퍼런스 스페이스 설정
                xrRefSpace = await session.requestReferenceSpace('local-floor');

                // 히트 테스트 소스 설정
                const viewerSpace = await session.requestReferenceSpace('viewer');
                hitTestSource = await session.requestHitTestSource({ space: viewerSpace });
                
                // 애니메이션 루프 시작
                renderer.setAnimationLoop(onXRFrame);
            } catch (error) {
                console.error('AR 세션 시작 중 오류:', error);
                document.getElementById('ar-ui-overlay').style.display = 'flex';
                arButton.disabled = false;
                arButton.textContent = 'AR 시작 실패';
            }
        }

        // 2. AR 세션 종료
        function onXRSessionEnded() {
            xrSession.removeEventListener('end', onXRSessionEnded);
            xrSession.removeEventListener('select', onSelect);
            
            if (hitTestSource) {
                hitTestSource.cancel();
                hitTestSource = null;
            }
            
            renderer.setAnimationLoop(null);
            xrSession = null;
            reticle.visible = false;
            
            // UI 다시 표시
            const arButton = document.getElementById('ar-start-button');
            document.getElementById('ar-ui-overlay').style.display = 'flex';
            arButton.disabled = false;
            arButton.textContent = 'AR 세션 종료됨 (다시 시작)';
        }

        // 3. AR 프레임 처리 (렌더링 루프)
        function onXRFrame(time, frame) {
            if (!xrSession || !xrRefSpace) return;
            
            const pose = frame.getViewerPose(xrRefSpace);
            
            if (pose) {
                // 뷰어 포즈를 기반으로 카메라 위치 업데이트 (Three.js가 자동으로 처리함)
                
                // 히트 테스트를 수행하여 리트클 위치 결정
                if (hitTestSource) {
                    const hitTestResults = frame.getHitTestResults(hitTestSource);

                    if (hitTestResults.length > 0) {
                        const hit = hitTestResults[0];
                        const pose = hit.getPose(xrRefSpace);

                        reticle.visible = true;
                        reticle.matrix.fromArray(pose.transform.matrix);
                    } else {
                        reticle.visible = false;
                    }
                }
            }

            // 씬 렌더링
            renderer.render(scene, camera);
        }

        // ------------------------------------
        // 상호작용 (큐브 배치)
        // ------------------------------------

        // 탭 이벤트 처리 (select 이벤트는 XR 세션 내의 터치/클릭에 해당)
        function onSelect() {
            if (reticle.visible) {
                // 리트클이 보이는 위치에 큐브 생성 및 배치
                const cube = new THREE.Mesh(cubeGeometry, cubeMaterial);
                
                // 리트클의 월드 행렬을 사용하여 큐브 위치 설정
                cube.applyMatrix4(reticle.matrix);
                
                scene.add(cube);
                
                // 사용자에게 배치되었다는 시각적 피드백 제공 (선택 사항: 큐브 크기 잠시 변경 등)
                console.log('큐브가 배치되었습니다!');
            } else {
                console.log('표면이 감지되지 않았습니다. 큐브를 배치할 수 없습니다.');
                // 사용자에게 피드백 제공이 필요하다면 여기에 UI 메시지를 추가할 수 있습니다.
            }
        }

        // ------------------------------------
        // 유틸리티
        // ------------------------------------

        // 창 크기 변경 시 Three.js 카메라 및 렌더러 업데이트
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // 문서 로드 완료 후 앱 시작
        window.addEventListener('load', init);

    </script>
</head>
<body>
    <!-- AR 시작 전 오버레이 UI -->
    <div id="ar-ui-overlay" class="bg-gray-900 bg-opacity-80 p-4">
        <div id="ar-button-container">
            <button
                id="ar-start-button"
                class="px-8 py-4 text-2xl font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded-xl shadow-2xl transition duration-150 ease-in-out disabled:bg-gray-400 disabled:cursor-not-allowed"
                disabled
            >
                AR 지원 확인 중...
            </button>
        </div>
    </div>
</body>
</html>