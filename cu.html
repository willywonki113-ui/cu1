<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR 시작 버튼 앱</title>
    <!-- Tailwind CSS (스타일링용) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* AR 씬이 화면을 가득 채우도록 설정 */
        #ar-scene {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* 기본적으로 배경에 위치 */
        }
        /* 앱 전체의 기본 스타일 */
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* 배경색 */
        }
        /* AR 시작 버튼 컨테이너를 화면 중앙에 배치 */
        #start-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
        }
    </style>
</head>
<body>

    <!-- Firebase 및 초기 인증 설정 (Canvas 환경 필수 boilerplate) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firestore 로깅 활성화 (디버깅 목적)
        setLogLevel('Debug');

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = null;
        if (typeof __firebase_config !== 'undefined') {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
            } catch (e) {
                console.error("Failed to parse firebase config:", e);
                // Fallback or exit
            }
        }
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;

        async function initFirebase() {
            if (firebaseConfig) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    }
                    window.db = db;
                    window.auth = auth;
                    window.userId = auth.currentUser?.uid || crypto.randomUUID();
                    window.appId = appId;

                    // 사용자 ID를 Firestore에 저장 (필요시)
                    await setDoc(doc(db, "artifacts", appId, "users", window.userId), {
                        lastLogin: new Date().toISOString(),
                        status: 'active'
                    }, { merge: true });

                } catch (error) {
                    console.error("Firebase Auth error:", error);
                }
            } else {
                console.warn("Firebase config not available. Running without persistence.");
            }
        }

        initFirebase();
    </script>
    
    <!-- A-Frame 라이브러리 로드 -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

    <!-- AR 시작 버튼을 포함하는 오버레이 -->
    <div id="start-container">
        <button id="ar-start-button" 
                class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-8 rounded-full shadow-2xl transition duration-300 ease-in-out transform hover:scale-105 active:scale-95 text-xl tracking-wider">
            AR 시작
        </button>
    </div>

    <!-- 
        A-Frame 씬 설정 
        - webxr: WebXR 기능을 활성화하고 AR 세션 타입을 설정합니다. 
        - vr-mode-ui="enabled: false": 기본 A-Frame의 VR/AR 버튼을 숨깁니다.
        - renderer="logarithmicDepthBuffer: true": AR 환경에서 깊이 렌더링을 개선합니다.
    -->
    <a-scene 
        id="ar-scene" 
        webxr="requiredFeatures: [hit-test, local-floor]; optionalFeatures: [dom-overlay]; overlayElement: #start-container;"
        renderer="logarithmicDepthBuffer: true;"
        vr-mode-ui="enabled: false">

        <!-- AR 카메라 (기본 설정) -->
        <a-camera></a-camera>

        <!-- AR 모드에서 표시될 간단한 객체 (녹색 상자) -->
        <!-- 이 객체는 AR 세션이 시작된 후, hit-test나 anchor 설정을 통해 화면에 배치될 수 있습니다. -->
        <a-box 
            position="0 0 -1" 
            rotation="0 45 0" 
            color="#4CAF50" 
            scale="0.3 0.3 0.3"
            shadow>
            <a-text value="AR 오브젝트" 
                    align="center" 
                    position="0 0.2 0" 
                    color="#FFFFFF" 
                    width="2"></a-text>
        </a-box>

    </a-scene>

    <script>
        const startButton = document.getElementById('ar-start-button');
        const arScene = document.getElementById('ar-scene');
        const startContainer = document.getElementById('start-container');

        // A-Frame 씬이 로드될 때까지 기다립니다.
        arScene.addEventListener('loaded', function () {
            console.log("A-Frame 씬 로드 완료.");
        });

        // AR 시작 버튼 클릭 이벤트 핸들러
        startButton.addEventListener('click', function () {
            console.log("AR 시작 버튼 클릭됨.");
            
            // A-Frame 씬의 enterAR() 메소드를 호출하여 AR 모드를 시작합니다.
            // A-Frame은 이 호출을 통해 WebXR API의 requestSession('immersive-ar')을 실행합니다.
            arScene.enterAR().then(() => {
                console.log("AR 모드 시작 요청 성공.");
                
                // AR 모드가 성공적으로 시작되면 오버레이 버튼을 숨깁니다.
                // startContainer.style.display = 'none'; // A-Frame이 AR 세션 시작 시 자동으로 DOM 오버레이를 처리할 수 있도록 optionalFeatures: [dom-overlay]를 설정합니다.
            }).catch(error => {
                // AR 시작 실패 처리 (예: 장치 미지원, 권한 거부 등)
                console.error("AR 모드 시작 실패:", error);
                const message = `AR 모드 시작에 실패했습니다. (오류: ${error.message}). 장치가 WebXR AR을 지원하는지 확인해주세요.`;
                
                // 사용자에게 오류 메시지를 표시합니다. (alert 대신 인라인 메시지 사용)
                startButton.textContent = message;
                startButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                startButton.classList.add('bg-red-500', 'hover:bg-red-600', 'text-sm');

                // 3초 후 원래대로 복구
                setTimeout(() => {
                    startButton.textContent = 'AR 시작';
                    startButton.classList.remove('bg-red-500', 'hover:bg-red-600', 'text-sm');
                    startButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'text-xl');
                }, 3000);
            });
        });

        // AR 세션이 종료되면 버튼을 다시 표시합니다.
        arScene.addEventListener('exit-vr', function () {
            // A-Frame에서 AR 종료 시 'exit-vr' 이벤트를 발생시킵니다.
            console.log("AR 모드 종료됨.");
            startContainer.style.display = 'flex';
        });

    </script>
</body>
</html>